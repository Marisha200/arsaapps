<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mensajes SITA - ARSA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Encabezado azul con botÃ³n de volver -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-800 shadow-lg relative">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8 text-center">
            <a href="index.html" class="absolute top-1/2 left-4 sm:left-6 lg:left-8 -translate-y-1/2 text-white hover:bg-white/20 p-2 rounded-full transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </a>
            <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white">ðŸ”§ MensajerÃ­a CHAMP</h1>
        </div>
    </header>

    <!-- Contenido Principal -->
    <main class="py-12">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-2 text-center">ðŸ”§ Extractor de Datos FWB / FFM </h2>
                <p class="text-center text-gray-600 mb-6">Pega el contenido de tus mensajes (FWB o FFM). La herramienta detectarÃ¡ el tipo automÃ¡ticamente.</p>

                <textarea id="xmlInput" rows="15" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow mb-4" placeholder="Pega aquÃ­ el contenido de tus archivos XML..."></textarea>

                <div class="flex flex-wrap items-center justify-center gap-3 mb-4">
                    <button id="processBtn" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Procesar XML
                    </button>
                    <button id="clearBtn" class="bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        Limpiar Todo
                    </button>
                    <button id="filterBtn" class="bg-yellow-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-yellow-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                        Mostrar solo incorrectos
                    </button>
                    <button id="copyBtn" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Copiar Tabla
                    </button>
                    <button id="exportBtn" class="bg-teal-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                        Exportar a XLS
                    </button>
                </div>
                <div id="statusMessage" class="text-center text-sm text-gray-600 min-h-[20px]"></div>

                <div class="mt-8 overflow-x-auto">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Resultados</h3>
                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                        <table id="resultsTable" class="min-w-full divide-y divide-gray-200">
                            <thead id="tableHeader" class="bg-gray-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Tipo</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Fecha</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Vuelo / AWB</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Origen</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Destino</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Los resultados se insertarÃ¡n aquÃ­ -->
                            </tbody>
                        </table>
                    </div>
                    <p id="noResults" class="text-center text-gray-500 py-8">AÃºn no hay datos para mostrar.</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center py-4 text-sm text-gray-500">
        <p>Marina - ARSA</p>
    </footer>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element Constants ---
            const processBtn = document.getElementById('processBtn');
            const clearBtn = document.getElementById('clearBtn');
            const copyBtn = document.getElementById('copyBtn');
            const exportBtn = document.getElementById('exportBtn');
            const filterBtn = document.getElementById('filterBtn');
            const xmlInput = document.getElementById('xmlInput');
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('resultsTableBody');
            const statusMessage = document.getElementById('statusMessage');
            const noResults = document.getElementById('noResults');
            let isFilterActive = false;

            // --- Function Declarations ---
            function showStatus(message, type = 'info') {
                statusMessage.textContent = message;
                statusMessage.className = 'text-center text-sm min-h-[20px]';
                if (type === 'success') statusMessage.classList.add('text-green-600');
                else if (type === 'error') statusMessage.classList.add('text-red-600');
                else statusMessage.classList.add('text-gray-600');
            }

            function updateTableVisibility() {
                const tableContainer = document.getElementById('resultsTable').closest('.border');
                if (tableBody.rows.length > 0) {
                    noResults.style.display = 'none';
                    tableContainer.style.display = 'block';
                } else {
                    noResults.style.display = 'block';
                    tableContainer.style.display = 'none';
                }
            }
            
            function getXmlStrings(rawText) {
                // This regex robustly finds XML blocks, ignoring surrounding log text.
                const xmlRegex = /<\?xml[\s\S]*?(?:<\/Message>|<\/SMLMessage>)/g;
                let matches = rawText.match(xmlRegex);
                
                if (matches) {
                    // Clean up any double quotes from string literals
                    return matches.map(match => match.replace(/""/g, '"'));
                }

                // Fallback for a single, non-standard XML block (e.g., without declaration)
                if (rawText.trim().startsWith('<')) {
                    return [rawText.trim().replace(/""/g, '"')];
                }

                return [];
            }

            function parseFWB(xmlDoc) {
                const messageNode = xmlDoc.querySelector('Message[type="FWB"]');
                if (!messageNode) return null;

                const get = (tagName) => {
                    const tags = messageNode.querySelectorAll(tagName);
                    return tags.length > 0 ? tags[tags.length - 1].textContent.trim() : null;
                }

                const day = get('DateOfMonth'), month = get('Month'), year = get('Year');
                const airlinePrefix = get('AirlinePrefix'), awbSerial = get('AwbSerialNumber');
                
                return {
                    type: 'FWB',
                    date: (day && month && year) ? `${day}/${month}/${year}` : 'N/A',
                    identifier: (airlinePrefix && awbSerial) ? `${airlinePrefix}-${awbSerial}` : 'N/A',
                    origin: get('orgAirpCode') || 'N/A',
                    destination: get('dstAirpCode') || 'N/A'
                };
            }

            function parseFFM(xmlDoc) {
                const ffmNode = xmlDoc.querySelector('FFM');
                if (!ffmNode) return null;

                const get = (tagName, parent = ffmNode) => parent.querySelector(tagName)?.textContent.trim() ?? null;

                const date = xmlDoc.querySelector('Date')?.textContent.split('T')[0] ?? 'N/A';
                const flightNode = ffmNode.querySelector('Flight');
                if (!flightNode) return null;

                const carrier = get('Carrier', flightNode), number = get('Number', flightNode);
                const day = get('Day', flightNode), month = get('Month', flightNode);

                return {
                    type: 'FFM',
                    date: date,
                    identifier: (carrier && number && day && month) ? `${carrier}${number}/${day}${month}` : 'N/A',
                    origin: get('AirportOfLoading') || 'N/A',
                    destination: get('AirportOfArrival') || 'N/A'
                };
            }

            function processXMLs() {
                tableBody.innerHTML = '';
                const rawText = xmlInput.value;
                if (!rawText.trim()) return showStatus('El campo de XML estÃ¡ vacÃ­o.', 'error');
                
                const xmlStrings = getXmlStrings(rawText);
                if (xmlStrings.length === 0) return showStatus('No se encontrÃ³ contenido XML vÃ¡lido.', 'error');

                const allResults = [];
                let errorCount = 0;
                const parser = new DOMParser();

                xmlStrings.forEach(xmlString => {
                    try {
                        const xmlDoc = parser.parseFromString(xmlString, "application/xml");
                        if (xmlDoc.querySelector("parsererror")) throw new Error("XML mal formado.");
                        
                        let result = parseFFM(xmlDoc) || parseFWB(xmlDoc);
                        
                        if (result && result.destination !== 'N/A' && result.destination !== null) {
                            allResults.push(result);
                        }
                    } catch (e) {
                        console.error("Error al parsear:", e.message, xmlString);
                        errorCount++;
                    }
                });

                renderResults(allResults);
                updateStatusCounters(allResults.length, errorCount);
            }

            function renderResults(results) {
                 const forbiddenDestinations = {
                    FWB: ['EZE', 'AEP', 'MDZ', 'MDQ', 'SLA', 'COR', 'IGR', 'RGA', 'USH'],
                    FFM: ['AEP', 'EZE', 'BRC', 'CRD', 'COR', 'CNQ', 'FTE', 'EPA', 'EQS', 'FMA', 'MDQ', 'MDZ', 'NQN', 'PSS', 'IGR', 'RES', 'RGL', 'RGA', 'ROS', 'SLA', 'JUJ', 'RHD', 'SDE', 'UAQ', 'MJR', 'AFA', 'RSA', 'SFN', 'VDM', 'USH', 'PMY', 'REL', 'NEC', 'PEH', 'LGS', 'ORA', 'IRJ', 'TTG', 'CTJ', 'ING', 'CLX', 'GGS']
                };

                results.forEach(res => {
                    const isIncorrect = forbiddenDestinations[res.type].includes(res.destination.toUpperCase());
                    const row = tableBody.insertRow();
                    row.dataset.status = isIncorrect ? 'incorrect' : 'correct';
                    
                    let statusHTML = isIncorrect
                        ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-bold">NO CORRESPONDE ENVIAR</td>`
                        : `<td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-bold">OK</td>`;

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-800 font-bold">${res.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${res.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-medium">${res.identifier}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${res.origin}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${res.destination}</td>
                        ${statusHTML}
                    `;
                });
            }

            function updateStatusCounters(processedCount, errorCount) {
                if (processedCount > 0) {
                    const correctCount = tableBody.querySelectorAll('[data-status="correct"]').length;
                    const incorrectCount = tableBody.querySelectorAll('[data-status="incorrect"]').length;
                    showStatus(`Procesados ${processedCount} mensajes. Correctos: ${correctCount}, Incorrectos: ${incorrectCount}. ${errorCount > 0 ? `(${errorCount} con error)` : ''}`, 'success');
                } else if (errorCount > 0) {
                    showStatus(`No se pudo procesar ningÃºn mensaje. ${errorCount} con errores de formato.`, 'error');
                } else {
                    showStatus('No se encontraron datos relevantes para extraer.', 'info');
                }
                updateTableVisibility();
            }

            function clearAll() {
                xmlInput.value = '';
                tableBody.innerHTML = '';
                showStatus('');
                if (isFilterActive) toggleFilter(); 
                updateTableVisibility();
            }

            function toggleFilter() {
                isFilterActive = !isFilterActive;
                Array.from(tableBody.rows).forEach(row => {
                    row.style.display = (isFilterActive && row.dataset.status === 'correct') ? 'none' : '';
                });
                
                filterBtn.textContent = isFilterActive ? 'Mostrar Todos' : 'Mostrar solo incorrectos';
                filterBtn.classList.toggle('bg-yellow-600', !isFilterActive);
                filterBtn.classList.toggle('hover:bg-yellow-700', !isFilterActive);
                filterBtn.classList.toggle('bg-gray-700', isFilterActive);
                filterBtn.classList.toggle('hover:bg-gray-800', isFilterActive);
            }

            function copyTableToClipboard() {
                if (tableBody.rows.length === 0) return showStatus('No hay datos para copiar.', 'error');
                
                let textToCopy = Array.from(tableHeader.querySelectorAll('th')).map(th => th.textContent).join('\t') + '\n';
                Array.from(tableBody.rows).forEach(row => {
                    if (row.style.display !== 'none') {
                        textToCopy += Array.from(row.cells).map(cell => cell.textContent).join('\t') + '\n';
                    }
                });
                
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showStatus('Â¡Tabla copiada al portapapeles!', 'success');
                    copyBtn.textContent = 'Â¡Copiado!';
                    setTimeout(() => { copyBtn.textContent = 'Copiar Tabla'; }, 2000);
                }, () => showStatus('Error al copiar la tabla.', 'error'));
            }

            function exportToXLS() {
                if (tableBody.rows.length === 0) return showStatus('No hay datos para exportar.', 'error');
                
                const table = document.getElementById('resultsTable');
                const wb = XLSX.utils.table_to_book(table, {sheet: "Resultados CHAMP"});
                const ws = wb.Sheets["Resultados CHAMP"];
                const range = XLSX.utils.decode_range(ws['!ref']);
                const statusColIndex = Array.from(tableHeader.querySelectorAll('th')).findIndex(th => th.textContent === 'Status');
                const headerStyle = { font: { bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "2d3748" } }, alignment: { horizontal: "center" } };
                ws['!cols'] = Array.from({length: range.e.c + 1}, () => ({wch: 22}));

                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cellRef = XLSX.utils.encode_cell({c: C, r: range.s.r});
                    if(ws[cellRef]) ws[cellRef].s = headerStyle;
                }

                for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                    if (statusColIndex > -1) {
                        const statusCellRef = XLSX.utils.encode_cell({c: statusColIndex, r: R});
                        if (ws[statusCellRef]) {
                            const statusValue = ws[statusCellRef].v;
                            if (statusValue === 'NO CORRESPONDE ENVIAR') ws[statusCellRef].s = { font: { bold: true, color: { rgb: "C00000" } }, fill: { fgColor: { rgb: "FFC7CE" } } };
                            else if (statusValue === 'OK') ws[statusCellRef].s = { font: { bold: true, color: { rgb: "006100" } }, fill: { fgColor: { rgb: "C6EFCE" } } };
                        }
                    }
                }

                try {
                    XLSX.writeFile(wb, `Resultados_CHAMP.xlsx`);
                    showStatus('Exportado a XLS exitosamente!', 'success');
                } catch (err) {
                    showStatus('Error al exportar la tabla.', 'error');
                }
            }
            
            // --- Event Listeners ---
            processBtn.addEventListener('click', processXMLs);
            clearBtn.addEventListener('click', clearAll);
            copyBtn.addEventListener('click', copyTableToClipboard);
            exportBtn.addEventListener('click', exportToXLS);
            filterBtn.addEventListener('click', toggleFilter);

            // --- Initial Setup Call ---
            updateTableVisibility();
        });
    </script>
</body>
</html>

